#!/bin/bash

source platform

PROJECTSFOLDERNAME=$(parse_config_item_custom_field "projects-folder-name" "$BW_CONFIG")
DBPASSWORD=$(bw generate --passphrase --words 3 -c --includeNumber --separator - --session "$BW_SESSION")
INSTALLATIONID=$(parse_config_item_custom_field "installation-id" "$BW_CONFIG")
INSTALLATIONKEY=$(parse_config_item_custom_field "installation-key" "$BW_CONFIG")
LICENSINGCERTPW=$(bw get password 7123e5d3-f837-4a8c-810a-a7ca00fe1fdd --session "$BW_SESSION")

setup_bitwarden_server () {
  mkdir -p $HOME/$PROJECTSFOLDERNAME
  cd $HOME/$PROJECTSFOLDERNAME
  git clone git@github.com:bitwarden/server
  cd server 
  git config blame.ignoreRevsFile .git-blame-ignore-revs
  git config --local core.hooksPath .git-hooks
  cd dev

  sudo cp .env.example .env
  sudo sed -i "s/SET_A_PASSWORD_HERE_123/$DBPASSWORD/g" .env
  sudo docker compose --profile cloud --profile mail up -d
  sudo pwsh -Command "Install-Module -Name Az -Scope CurrentUser -Repository PSGallery -Force"
  sudo pwsh setup_azurite.ps1
  sudo pwsh migrate.ps1
  sudo ./create_certificates_linux.sh > fingerprints.txt
  sudo mv data_protection_dev.crt /usr/local/share/ca-certificates/
  sudo mv identity_server_dev.crt /usr/local/share/ca-certificates/
  sudo update-ca-certificates
  pwsh -Command "using namespace System.Security.Cryptography.X509Certificates; \$store = [X509Store]::new('My', 'CurrentUser', 'ReadWrite'); \$store.Add([X509Certificate2]::new('/home/me/environment-setup/dev.pfx', '$LICENSINGCERTPW', [X509KeyStorageFlags]::PersistKeySet)); \$store.Dispose()"
  h3 "Configuring project sectets"
  IDENTITYFINGERPRINT=$(awk '/Identity Server Dev/ { print $4}' fingerprints.txt)
  DATAPROTECTIONFINGERPRINT=$(awk '/Data Protection Dev/ { print $4}' fingerprints.txt)
  sudo rm fingerprints.txt
  bw get attachment secrets-for-env-setup.json --itemid d4195f67-dd43-4465-84d7-ae320013e6ff --session $BW_SESSION
  sudo mv secrets-for-env-setup.json secrets.json
  bw get attachment additional-keys-for-cloud-services.json --itemid d4195f67-dd43-4465-84d7-ae320013e6ff --session $BW_SESSION
  sudo sed -i "s/DB_PASSWORD/$DBPASSWORD/g" secrets.json
  sudo sed -i "s/DATAPROTECTION_THUMBPRINT/$DATAPROTECTIONFINGERPRINT/g" secrets.json
  sudo sed -i "s/IDENTITY_THUMBPRINT/$IDENTITYFINGERPRINT/g" secrets.json
  sudo sed -i "s/INSTALLATION_ID/$INSTALLATIONID/g" secrets.json
  sudo sed -i "s/INSTALLATION_KEY/$INSTALLATIONKEY/g" secrets.json
  pwsh setup_secrets.ps1
}

setup_bitwarden_server
