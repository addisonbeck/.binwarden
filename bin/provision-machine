#!/usr/bin/bash

init () {
  git clone https://github.com/addisonbeck/environment-setup.git 
  cd environment-setup
  git fetch -a
  git checkout dev
  cd bin

  export PATH="$(pwd)${PATH:+:${PATH}}" 

  source platform
  source install-bitwarden
  source configure-secrets

  export OSUSERNAME=$(parse_config_item_custom_field "system-username" $BW_CONFIG)
  export PROJECTSFOLDERNAME=$(parse_config_item_custom_field "projects-folder-name" $BW_CONFIG)
}

set_timezone () {
  sudo timedatectl set-timezone America/Chicago
}

build_user_directory () {
  mkdir -p /home/$OSUSERNAME/.ssh
  mkdir -p /home/$OSUSERNAME/.cache
  mkdir -p /home/$OSUSERNAME/$PROJECTSFOLDERNAME
}

copy_user_ssh_keys () {
  cp /root/.ssh/authorized_keys /home/$OSUSERNAME/.ssh/
}

create_user () {
  useradd -G sudo --shell /bin/bash $OSUSERNAME
}

remove_sudo_password_requirement () {
  echo "$OSUSERNAME ALL=(ALL:ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/$OSUSERNAME
}

set_user_permissions () {
  chown -R $OSUSERNAME:$OSUSERNAME /home/$OSUSERNAME/
  chown -R $OSUSERNAME:$OSUSERNAME /home/$OSUSERNAME
  chmod 700 /home/$OSUSERNAME/.ssh
  chmod 700 /home/$OSUSERNAME/$PROJECTSFOLDERNAME
  chmod 644 /home/$OSUSERNAME/.ssh/authorized_keys
  chmod 700 /home/$OSUSERNAME/.cache
}

install_self () {
  cd /home/$OSUSERNAME/$PROJECTSFOLDERNAME
  su -s /bin/bash -c "git clone https://github.com/addisonbeck/environment-setup.git && cd environment-setup && git fetch -a && git checkout -f dev && git remote set-url origin git@github.com:addisonbeck/environment-setup.git" -l $OSUSERNAME
}

disable_root_login () {
  sudo sed -i '/^'"PermitRootLogin"'/d' /etc/ssh/sshd_config
  sudo echo "PermitRootLogin no" >> /etc/ssh/sshd_config
}

login () {
  su -l $OSUSERNAME -w "BW_SESSION,BW_CONFIG"
}

init
set_timezone
build_user_directory
copy_user_ssh_keys
create_user
remove_sudo_password_requirement
set_user_permissions
install_self
disable_root_login
login
